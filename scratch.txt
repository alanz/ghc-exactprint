Annotation values from the Delta phase.

In withAST
----------

edp : entry delta.
  This is the offset from the previous output item and the current item.
  Initially just the straight (deltaLine,deltaCol) value
  Then corrected via adjustDeltaForOffsetM
      currentColOffset
  So if it is on the same line it is unchanged, else
  it is calculated relative to the existing colOffset

Stored as offset in the withSrcSpanDelta calculation
and then retrieved to store in Annotation as `ann_entry_delta`

nl : Did the original span start on a new line wrt to the prior one?
     prior meaning higher up the stack

     This encodes Line same/changed, as well as Layout on/off

--------------------------------------------------
Attempt at formalisation

Delta phase (withAST)
=====================
Let
  (pr,pc), be the row and column of the most recently processed annotated item.
          This corresponds to the current output position in the Print phase.

  ((sr,sc)(er,ec)) be the start and end row/col of the SrcSpan we are currently
                 entering.

  ((psr,psc)(per,pec)) be the start and end row/col of the SrcSpan prior to
                 this on the stack

So
  Ann has
    DP (sr - pr,if sr - pr == 0 then sc - pr else sc - psc)
        the entry delta position (edp) as derived below

    nl = if sr /= psr then LineChanged else if layout == LayoutRules then LayoutLineSame else LineSame 

    sc

    dp = if sr == psr then sc - psc else sc

Print phase (withOffset)
========================
Let
  (co,ci) be the current column offset and column indent
  cc      be the column where current output will happen

Using the annotation from the Delta phase then
the new (co,ci) is

  case nl of
    LineChanged    : (if sr == psr then sc - psc else sc) + ci
                     ci
    LineSame       : (if sr == psr then sc - psc else sc) + co
                     ci
    LayoutLineSame : (if sr == psr then sc - psc else sc) + co +
                       ((if sr == psr then sc - psc + cc else co)
                         - sc)
                     (if sr == psr then sc - psc + cc else co)
LayoutLineSame derivation
--------------------------
(if sr == psr then sc - psc else sc) + co + (if sr == psr then sc - psc + cc else co) - sc)
(if sr == psr then sc - psc + cc else co)
============ In the sr == psr case
(sc - psc ) + co + (sc - psc + cc) - sc)
(sc - psc + cc)
==
sc - psc + co - psc + cc 
(sc - psc + cc)
==
sc - (2 * psc) + co + cc 
(sc - psc + cc)

============ In the sr /= psr case
sc + co + co - sc
co
==
2 * co
co

nl derivation
-------------
      getCurrentDP layout ((sr,sc)(er,ec)) ((psr,psc)(per,pec))
      ==
      colOffset = if sr == psr then sc - psc else sc
      nl = if sr /= psr then LineChanged else if layout == LayoutRules then LayoutLineSame else LineSame 
      
edp derivation
--------------
      deltaFromSrcSpans pe ss
      ==
      deltaFromSrcSpans (_,(pr,pc)), ((sr,sc),(er,ec))
      ==
      ss2delta (ss2posEnd (_,(pr,pc))) ((sr,sc),(er,ec)) 
      ==
      ss2delta (pr,pc) ((sr,sc),(er,ec)) 
      ==
      ss2deltaP (pr,pc) (ss2pos ((sr,sc),(er,ec)))
      ==
      ss2deltaP (pr,pc) (sr,sc)
      ==
      lo = sr - pr
      co = if lo == 0 then sc - pr else sc
      DP (sr - pr,if sr - pr == 0 then sc - pr else sc)
      ================
      adjustDeltaForOffsetM (DP (sr - pr,if sr - pr == 0 then sc - pr else sc))
      ==
      adjustDeltaForOffset psc (DP (sr - pr,if sr - pr == 0 then sc - pr else sc))
      ==
      DP (sr - pr,if sr - pr == 0 then sc - pr else sc - psc)

--------------------------------------------------

getCurrentDP
  ss = span we are annotating
  ps = previous (higher up stack) span

  colOffset is the start col of ss if ss and ps have different start lines,
       else the difference in start columns between them.

  The LineSame/LineChanged part is set according to the colOffset logic
  The Layout On/Off is set according to the layout flag passed in
      The flag is set iff layout needs to be captured for an item.

original_col is set to the original column of the SrcSpan being annotated.

The dp is set to colOffset from getCurrentDP


Annotation usage in the Print Phase
-----------------------------------
  (in withOffset)

epStack has a (colOffset,colIndent) for each SrcSpan.

The current output position is stored in the Monad, retrieved as
(_l, currentColumn)

A new indentation value is calculated only iff
  1) Layout is flagged to be captured
  2) LineSame is set.


The process is to calculate a newStartColumn, based on the original edp value
  If the original edp was on the same line, this simply
      the current output position + the edp col.
  Otherwise it is the current colOffset, as the indentation cannot change going on to a new line.

The new colOffset value is calculated depending on the LineChanged value.
  If the line has changed, the line is started at
     the existing colIndent value + the dp from Ann
     The new colOffset is calculated as the old colOffset + the dp from Ann
     if layout is being captured
        the new colOffset is adjusted by the difference between the new and old indent values. 


